/** * Created by asus on 2017/2/28. */$(function() {    var msg = RUrl.queryString("msg");    if (msg) showerror(msg);    //用户登录    $("#loginbtn").click(function () { login(); });});function login() {    $("#errormsg").text("");    var username = $("#input_username").val();    var password = $("#input_password").val();    if (username == "" || password == "") {        showerror("用户名和密码不可为空！");    }    else {        $("#loginbtn").html("Logining...");        tms.services.userLogin({            requestBody: {                UserName: username,                PassWord: password            },            callback:function (res){                //uc                var uc = Cookies.getJSON("usercache");                uc.CompanyId = res["CompanyId"];                Cookies.set("usercache",JSON.stringify(uc),{ expires: 1/24 });                //bp1                var bp1 = tms.getLocalStorage("browseparam1",true) || {};                bp1.CurrentCompanyId = res["CompanyId"];                bp1.SignatureType = res["SignatureType"];                tms.setLocalStorage("browseparam1",bp1,true);                //加载当前用户权限                loginPower();            },            errCallback:function (msg) {                $("#loginbtn").html("Login");                showerror(msg);            }        });    }}function loginPower() {    tms.services.getPower({        callback:function (res) {            console.log(res);            var permissionArray = transferPower(res.MenuItems);            tms.setLocalStorage("permission",permissionArray,true);            window.location.href = "/index";        }    })}//根据获取到的权限数据MenuItems，转换成权限数字数组[2,3,4]function transferPower(data,bool){    if(!bool) {        permission = [];    }    for(var i=0,len=data.length;i<len;i++) {        var item = data[i];        if(permission.indexOf(item.Value) < 0 && item.IsChecked) {            permission.push(item.Value);        }        if(item.Children && item.Children.length > 0) {            arguments.callee.call(this,item.Children,true);        }    }    return permission;}// 回车键登录$(document).keydown(function (event) {    var e = event || window.event || arguments.callee.caller.arguments[0];    if (e && e.keyCode == 13) {        login();    }});function showerror(msg) {    $("#errormsg").html(("" + msg).encodeHtml());}